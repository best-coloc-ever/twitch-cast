<head>
  <script async>
    var APPLICATION_ID = '8F368C04'
    var session = null;
    var currentStream = null;

    function sessionListener(e) {
      session = e;
      if (session.media.length)
        console.log('Session discovered: ' + session.media[0]);
    }

    function play() {
      var mediaInfo = new chrome.cast.media.MediaInfo(
        currentStream.proxy.indexUrl,
        'application/vnd.apple.mpegurl'
      );
      var request = new chrome.cast.media.LoadRequest(mediaInfo);

      function onMediaDiscovered(how, media) {
        currentMedia = media;
      }

      session.loadMedia(
        request,
        onMediaDiscovered.bind(this, 'loadMedia'),
        console.error.bind(console, 'Error loading media')
      );
    }

    function onRequestSessionSuccess(e) {
      console.log('Session success:');
      session = e;

      play();
    }

    function cast() {
      if (currentStream != null) {
        if (session == null)
          chrome.cast.requestSession(
            onRequestSessionSuccess,
            console.error.bind(console, 'Failed to launch a session request')
          );
        else
          play();
      }
      else
        alert('No current stream!');
    }

    function receiverListener(e) {
      if (e === chrome.cast.ReceiverAvailability.AVAILABLE) {
        console.log('Receiver available');
      }
    }

    function initializeCastApi() {
      var sessionRequest = new chrome.cast.SessionRequest(APPLICATION_ID);
      var apiConfig = new chrome.cast.ApiConfig(
        sessionRequest,
        sessionListener,
        receiverListener
      );

      chrome.cast.initialize(
        apiConfig,
        console.log.bind(console, 'Chromecast succesfully initialized'),
        console.error.bind(console, 'Error while initializing Chromecast')
      );
    }

    function initialize(loaded, errorInfo) {
      if (loaded)
        initializeCastApi();
      else
        console.log(errorInfo);
    }

    window['__onGCastApiAvailable'] = initialize;

  </script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js" defer></script>
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>

<body>
  <div class="col-md-6 col-md-offset-3">
    <div class="container-fluid">

      <div class="jumbotron">
        <h1>Twitch Cast</h1>
        <button class="btn btn-primary btn-lg" onclick="cast()">Start Casting!</button>
      </div>

      <div class="container-fluid">
        <div class="well">

          <div class="input-group">
            <input type="text" placeholder="Add a channel" class="form-control" id="channel">
            <span class="input-group-btn">
              <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Monitor<span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  <li><a href="#" id="watch-best">Best (Source)</a></li>
                  <li><a href="#" id="watch-high">High</a></li>
                  <li><a href="#" id="watch-medium">Medium</a></li>
                  <li><a href="#" id="watch-low">Low</a></li>
                  <li><a href="#" id="watch-worst">Worst</a></li>
                </ul>
              </div>
            </span>
          </div>

          <h2>Monitored streams:</h2>
          <button type="button" class="btn btn-default" onclick="fetchStreams()">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
          </button><br><br>
          <div id="streams" class="container-fluid">
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    var streams;

    function monitor(quality) {
      $.ajax({
        method: 'POST',
        url: '/streamer/streams',
        contentType: 'application/json',
        data: JSON.stringify({
          'channel': $('#channel').val(),
          'quality': quality
        }),
        success: function(response) {
          fetchStreams();
        },
        error: function(response) {
          alert(response)
        }
      });
    }

    function unmonitor(stream_id) {
      $.ajax({
        method: 'DELETE',
        url: '/streamer/streams/' + stream_id,
      });
    }

    function watch(stream_id) {
      $.ajax({
        method: 'POST',
        url: '/streamer/streams/' + stream_id + '/watch',
      });
    }

    function unwatch(stream_id) {
      $.ajax({
        method: 'POST',
        url: '/streamer/streams/' + stream_id + '/unwatch',
      });
    }

    function displayStreams() {
      var container = $('#streams');
      container.empty();

      streams.forEach(function(stream) {
        var proxy = stream.proxy;

        var urlLabel = $('<span>')
            .addClass('label label-default')
            .text(stream['url']);
        var qualityLabel = $('<span>')
            .addClass('label label-info')
            .text(stream['quality']);
        var watchButton = $('<button>')
          .addClass('btn btn-sm pull-right')
          .text('Watch')
          .click(function() { watch(stream.id); fetchStreams(); });
        if (proxy) {
          watchButton.unbind();
          watchButton.text(proxy.ready ? 'Stop Watching' : 'Fetching...');
          watchButton.addClass(proxy.ready ? 'btn-danger' : 'btn-info');
          if (proxy.ready)
            watchButton.click(function() { unwatch(stream.id); fetchStreams(); })
        }
        var unmonitorButton = $('<button>')
          .addClass('btn btn-sm')
          .click(function() { unmonitor(stream.id); fetchStreams(); })
          .wrapInner($('<span>')
            .addClass('glyphicon glyphicon-remove')
          );

        var div = $('<div>')
          .addClass('col-md-12')
          .append(
            unmonitorButton, ' ',
            urlLabel, ' ',
            qualityLabel, ' ',
            watchButton
          );

        if (!currentStream || currentStream.id != stream.id) {
          if (proxy && proxy.ready) {
            var makeCurrentButton = $('<button>')
              .addClass('btn btn-primary btn-sm pull-right')
              .text('Make current stream')
              .click(function() {
                currentStream = stream;
                displayStreams();
                cast();
              });

            div.append(makeCurrentButton);
          }
        }
        else {
          div.append($('<span>')
            .addClass('label label-primary')
            .text('Current stream')
          );
        }

        var row = $('<div>')
          .addClass('row')
          .append(div)

        container.append(row);
      });
    }

    function fetchStreams() {
      $.ajax({
        url: '/streamer/streams',
        success: function(json) {
          streams = json;
          displayStreams();
        }
      });
    }

    function initDom() {
      $('#watch-best')  .click(monitor.bind(null, 'best'));
      $('#watch-high')  .click(monitor.bind(null, 'high'));
      $('#watch-medium').click(monitor.bind(null, 'medium'));
      $('#watch-low')   .click(monitor.bind(null, 'low'));
      $('#watch-worst') .click(monitor.bind(null, 'worst'));

      fetchStreams();
    }

    $(initDom);
  </script>

</body>
