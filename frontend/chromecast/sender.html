<head>
  <script async>
    var APPLICATION_ID = '8F368C04'
    var CAST_DELAY = 15000;
    var session;

    function sessionListener(e) {
      session = e;
      if (session.media.length)
        console.log('Session discovered: ' + session.media[0]);
    }

    function onRequestSessionSuccess(e) {
      console.log('Session success:');
      session = e;

      var mediaInfo = new chrome.cast.media.MediaInfo(
        '/video/stream.m3u8',
        'application/vnd.apple.mpegurl'
      );
      var request = new chrome.cast.media.LoadRequest(mediaInfo);

      function onMediaDiscovered(how, media) {
        currentMedia = media;
      }

      session.loadMedia(
        request,
        onMediaDiscovered.bind(this, 'loadMedia'),
        console.error.bind(console, 'Error loading media')
      );
    }

    function cast() {
      var channel = $("#channel");
      var formData = new FormData();
      formData.append('channel', channel.val());

      $.ajax({
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        url: '/stream',
        success: function(data) {
          $('#state').text('Ready soon...');
          setTimeout(function() {
            $('#state').text('Ready!')
            chrome.cast.requestSession(
              onRequestSessionSuccess,
              console.error.bind(console, 'Failed to launch a session request')
            );
          }, CAST_DELAY);
        }
      });
    }

    function receiverListener(e) {
      if (e === chrome.cast.ReceiverAvailability.AVAILABLE) {
        console.log('Receiver available');
      }
    }

    function initializeCastApi() {
      var sessionRequest = new chrome.cast.SessionRequest(APPLICATION_ID);
      var apiConfig = new chrome.cast.ApiConfig(
        sessionRequest,
        sessionListener,
        receiverListener
      );

      chrome.cast.initialize(
        apiConfig,
        console.log.bind(console, 'Chromecast succesfully initialized'),
        console.error.bind(console, 'Error while initializing Chromecast')
      );
    }

    function initialize(loaded, errorInfo) {
      if (loaded)
        initializeCastApi();
      else
        console.log(errorInfo);
    }

    window['__onGCastApiAvailable'] = initialize;
  </script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js" defer></script>
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
</head>

<body>
  <label>Channel: </label>
  <input type="text" id="channel">
  <button onclick="cast()">Cast</button>
  <div id="state"></div>
</body>
